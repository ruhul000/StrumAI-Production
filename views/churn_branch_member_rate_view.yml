version: 1
type: view
name: churn_branch_member_rate_view
description: Derived table for calculating member churn rate per period and branch
model_name: strum_platform_model
default_date: data_period
derived_table:
  sql: |
    SELECT
        pm.DataPeriod,
        b.Name AS BranchName,
        COALESCE(lost.CustomersLostDuringPeriod, 0) AS CustomersLostDuringPeriod,
        COALESCE(start.TotalCustomersBeginningPeriod, 0) AS TotalCustomersBeginningPeriod,
        COALESCE(pf.IsEarliestPeriodCheck, 0) AS IsEarliestPeriodCheck,
        CASE
            WHEN COALESCE(pf.IsEarliestPeriodCheck, 0) = 1
              OR COALESCE(start.TotalCustomersBeginningPeriod, 0) = 0 THEN NULL
            ELSE (COALESCE(lost.CustomersLostDuringPeriod, 0) * 1.0
                  / NULLIF(COALESCE(start.TotalCustomersBeginningPeriod, 0), 0)) * -1
        END AS ChurnRate
    FROM (
        SELECT 
            dp.DataPeriod,
            LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
        FROM (
            SELECT DISTINCT DataPeriod 
            FROM customers
            WHERE DataPeriod != '1900-01-01' 
        ) dp
    ) pm
    LEFT JOIN (
        SELECT
            c.DataPeriod,
            c.BranchId,
            COUNT(DISTINCT CASE WHEN c.status = 3 THEN c.custid END) * -1 AS CustomersLostDuringPeriod
        FROM customers c
        WHERE c.DataPeriod != '1900-01-01' 
        GROUP BY c.DataPeriod, c.BranchId
    ) lost 
        ON pm.DataPeriod = lost.DataPeriod
    LEFT JOIN (
        SELECT
            prev_map.DataPeriod,
            prev.BranchId,
            COUNT(DISTINCT CASE WHEN prev.islost = 0 THEN prev.custid END) AS TotalCustomersBeginningPeriod
        FROM (
            SELECT 
                dp.DataPeriod,
                LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
            FROM (
                SELECT DISTINCT DataPeriod 
                FROM customers
                WHERE DataPeriod != '1900-01-01' 
            ) dp
        ) prev_map
        LEFT JOIN customers prev 
            ON prev.DataPeriod = prev_map.PreviousPeriod
        GROUP BY prev_map.DataPeriod, prev.BranchId
    ) start 
        ON pm.DataPeriod = start.DataPeriod 
        AND lost.BranchId = start.BranchId
    LEFT JOIN (
        SELECT
            dp.DataPeriod,
            CASE 
                WHEN dp.DataPeriod = (
                    SELECT MIN(DataPeriod) 
                    FROM customers
                    WHERE DataPeriod != '1900-01-01'
                ) THEN 1 ELSE 0 
            END AS IsEarliestPeriodCheck
        FROM (
            SELECT DISTINCT DataPeriod 
            FROM customers
            WHERE DataPeriod != '1900-01-01' 
        ) dp
    ) pf 
        ON pm.DataPeriod = pf.DataPeriod
    LEFT JOIN branch b 
        ON CONCAT(COALESCE(lost.BranchId, start.BranchId), lost.DataPeriod)
           = CONCAT(b.BranchId, b.DataPeriod)
    GROUP BY
        pm.DataPeriod,
        b.Name,
        lost.CustomersLostDuringPeriod,
        start.TotalCustomersBeginningPeriod,
        pf.IsEarliestPeriodCheck
fields:
- name: prim_key
  field_type: dimension
  type: string
  hidden: true
  primary_key: true
  sql: concat(${data_period_raw}, ${total_customers_beginning_period})
  searchable: true

- name: dataperiod
  field_type: dimension
  type: number
  hidden: false
  sql: ${TABLE}."DataPeriod"
  searchable: true

- name: branch_name
  field_type: dimension
  type: string
  hidden: false
  label: Branch Name
  description: The name of the branch associated with the members
  sql: ${TABLE}.BranchName
  searchable: true

- name: customers_lost_during_period
  field_type: dimension
  type: number
  hidden: false
  label: Members Lost During Period
  sql: ${TABLE}.CustomersLostDuringPeriod
  searchable: true

- name: total_customers_beginning_period
  field_type: dimension
  type: number
  hidden: false
  label: Total Members at Beginning of Period
  sql: ${TABLE}.TotalCustomersBeginningPeriod
  searchable: true

- name: is_earliest_period_check
  field_type: dimension
  type: number
  hidden: false
  description: Flag indicating the earliest period (1) or not (0)
  sql: ${TABLE}.IsEarliestPeriodCheck

- name: data_period
  field_type: dimension_group
  type: time
  datatype: date
  hidden: true
  description: The snapshot period (end of month) associated with each row
  timeframes:
  - raw
  - date
  - month
  sql: ${TABLE}.DataPeriod

- name: churn_rate
  field_type: measure
  type: number
  label: Branch Member Churn Rate
  description: Member churn rate calculated per branch per period
  value_format_name: percent_2
  sql: MAX(${TABLE}.ChurnRate)

