version: 1
type: view
name: churn_member_rate_view
description: Derived table for calculating members churn rate per period
model_name: strum_platform_model
default_date: data_period
derived_table:
  sql: |-
    SELECT
    pm.DataPeriod,
    COALESCE(lost.CustomersLostDuringPeriod, 0) AS CustomersLostDuringPeriod,
    COALESCE(start.TotalCustomersBeginningPeriod, 0) AS TotalCustomersBeginningPeriod,
    COALESCE(pf.IsEarliestPeriodCheck, 0) AS IsEarliestPeriodCheck,
    CASE
      WHEN COALESCE(pf.IsEarliestPeriodCheck, 0) = 1
        OR COALESCE(start.TotalCustomersBeginningPeriod, 0) = 0 THEN NULL
      ELSE (COALESCE(lost.CustomersLostDuringPeriod, 0) * 1.0
            / NULLIF(COALESCE(start.TotalCustomersBeginningPeriod, 0), 0)) * -1
    END AS ChurnRate
    FROM (
    SELECT 
      dp.DataPeriod,
      LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
    FROM (
      SELECT DISTINCT DataPeriod FROM customers
      WHERE DataPeriod != '1900-01-01' 
    ) dp
    ) pm
    LEFT JOIN (
    SELECT
      c.DataPeriod,
      COUNT(DISTINCT CASE WHEN c.status = 3 THEN c.custid END) * -1 AS CustomersLostDuringPeriod
    FROM customers c
    WHERE c.DataPeriod != '1900-01-01' 
    GROUP BY c.DataPeriod
    ) lost ON pm.DataPeriod = lost.DataPeriod
    LEFT JOIN (
    SELECT
      prev_map.DataPeriod,
      COUNT(DISTINCT CASE WHEN prev.islost = 0 THEN prev.custid END) AS TotalCustomersBeginningPeriod
    FROM (
      SELECT 
        dp.DataPeriod,
        LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
      FROM (
        SELECT DISTINCT DataPeriod FROM customers
        WHERE DataPeriod != '1900-01-01' 
      ) dp
    ) prev_map
    LEFT JOIN customers prev ON prev.DataPeriod = prev_map.PreviousPeriod
    GROUP BY prev_map.DataPeriod
    ) start ON pm.DataPeriod = start.DataPeriod
    LEFT JOIN (
    SELECT
      dp.DataPeriod,
      CASE WHEN dp.DataPeriod = (SELECT MIN(DataPeriod) FROM customers
      WHERE DataPeriod != '1900-01-01') THEN 1 ELSE 0 END AS IsEarliestPeriodCheck
    FROM (
      SELECT DISTINCT DataPeriod FROM customers
      WHERE DataPeriod != '1900-01-01' 
    ) dp
    ) pf ON pm.DataPeriod = pf.DataPeriod
    GROUP BY
    pm.DataPeriod, 
    lost.CustomersLostDuringPeriod,
    start.TotalCustomersBeginningPeriod,
    pf.IsEarliestPeriodCheck
fields:
- name: prim_key
  field_type: dimension
  type: string
  hidden: true
  primary_key: true
  sql: concat(${data_period_raw}, ${total_customers_beginning_period})
  searchable: true

- name: dataperiod
  field_type: dimension
  type: number
  hidden: false
  sql: ${TABLE}."DataPeriod"
  searchable: true

- name: customers_lost_during_period
  field_type: dimension
  type: number
  hidden: false
  label: Customers Lost
  sql: ${TABLE}.CustomersLostDuringPeriod
  searchable: true

- name: total_customers_beginning_period
  field_type: dimension
  type: number
  hidden: false
  label: Total Customers at Start
  sql: ${TABLE}.TotalCustomersBeginningPeriod
  searchable: true

- name: is_earliest_period_check
  field_type: dimension
  type: number
  hidden: false
  description: Flag indicating the earliest period (1) or not (0)
  sql: ${TABLE}.IsEarliestPeriodCheck

- name: data_period
  field_type: dimension_group
  type: time
  datatype: date
  hidden: true
  description: The snapshot period (end of month) associated with each row
  timeframes:
  - raw
  - date
  - month
  sql: ${TABLE}.DataPeriod

- name: churn_rate
  field_type: measure
  type: number
  label: Members Churn Rate
  description: Churn rate calculated at runtime to avoid GROUP BY conflict.
  value_format_name: percent_2
  sql: MAX(${TABLE}.ChurnRate)

- name: churn_rate_avg
  field_type: measure
  type: average
  label: Avg Member Churn Rate
  description: Churn rate calculated at runtime to avoid GROUP BY conflict.
  value_format_name: percent_2
  sql: ${TABLE}.ChurnRate



