version: 1
type: view
name: churn_branch_account_rate_view
description: Derived table for calculating account churn rate per period and branch
model_name: strum_platform_model
default_date: data_period
derived_table:
  sql: |-
    SELECT
        pm.DataPeriod,
        b.Name AS BranchName,
        COALESCE(lost.AccountsLostDuringPeriod, 0) AS AccountsLostDuringPeriod,
        COALESCE(start.TotalAccountsBeginningPeriod, 0) AS TotalAccountsBeginningPeriod,
        COALESCE(pf.IsEarliestPeriodCheck, 0) AS IsEarliestPeriodCheck,
        CASE
            WHEN COALESCE(pf.IsEarliestPeriodCheck, 0) = 1
              OR COALESCE(start.TotalAccountsBeginningPeriod, 0) = 0 THEN NULL
            ELSE (COALESCE(lost.AccountsLostDuringPeriod, 0) * 1.0
                  / NULLIF(COALESCE(start.TotalAccountsBeginningPeriod, 0), 0)) * -1
        END AS ChurnRate
    FROM (
        SELECT 
            dp.DataPeriod,
            LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
        FROM (
            SELECT DISTINCT DataPeriod 
            FROM accounts
            WHERE DataPeriod != '1900-01-01' 
        ) dp
    ) pm
    LEFT JOIN (
        SELECT
            c.DataPeriod,
            c.branchid,
            COUNT(DISTINCT CASE WHEN c.status = 3 THEN c.acctid END) * -1 AS AccountsLostDuringPeriod
        FROM accounts c
        WHERE c.DataPeriod != '1900-01-01' 
        GROUP BY c.DataPeriod, c.branchid
    ) lost 
        ON pm.DataPeriod = lost.DataPeriod
    LEFT JOIN (
        SELECT
            prev_map.DataPeriod,
            prev.branchid,
            COUNT(DISTINCT CASE WHEN prev.islost = 0 THEN prev.acctid END) AS TotalAccountsBeginningPeriod
        FROM (
            SELECT 
                dp.DataPeriod,
                LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
            FROM (
                SELECT DISTINCT DataPeriod 
                FROM accounts
                WHERE DataPeriod != '1900-01-01' 
            ) dp
        ) prev_map
        LEFT JOIN accounts prev 
            ON prev.DataPeriod = prev_map.PreviousPeriod
        GROUP BY prev_map.DataPeriod, prev.branchid
    ) start 
        ON pm.DataPeriod = start.DataPeriod 
        AND lost.branchid = start.branchid
    LEFT JOIN (
        SELECT
            dp.DataPeriod,
            CASE 
                WHEN dp.DataPeriod = (
                    SELECT MIN(DataPeriod) 
                    FROM accounts
                    WHERE DataPeriod != '1900-01-01'
                ) THEN 1 ELSE 0 
            END AS IsEarliestPeriodCheck
        FROM (
            SELECT DISTINCT DataPeriod 
            FROM accounts
            WHERE DataPeriod != '1900-01-01' 
        ) dp
    ) pf 
        ON pm.DataPeriod = pf.DataPeriod
    LEFT JOIN branch b 
        ON CONCAT(COALESCE(lost.branchid, start.branchid), lost.DataPeriod)
           = CONCAT(b.branchid, b.DataPeriod)
    GROUP BY
        pm.DataPeriod,
        b.Name,
        lost.AccountsLostDuringPeriod,
        start.TotalAccountsBeginningPeriod,
        pf.IsEarliestPeriodCheck
fields:
- name: prim_key
  field_type: dimension
  type: string
  hidden: true
  primary_key: true
  sql: concat(${data_period_raw}, ${total_accounts_beginning_period})
  searchable: true

- name: dataperiod
  field_type: dimension
  type: number
  hidden: false
  sql: ${TABLE}."DataPeriod"
  searchable: true

- name: branch_name
  field_type: dimension
  type: string
  hidden: false
  label: Churn Branch Name
  description: The name of the branch associated with the accounts
  sql: ${TABLE}.BranchName
  searchable: true

- name: account_lost_during_period
  field_type: dimension
  type: number
  hidden: false
  label: Accounts Lost During Period
  sql: ${TABLE}.AccountsLostDuringPeriod
  searchable: true

- name: total_accounts_beginning_period
  field_type: dimension
  type: number
  hidden: false
  label: Total Accounts at Beginning of Period
  sql: ${TABLE}.TotalAccountsBeginningPeriod
  searchable: true

- name: is_earliest_period_check
  field_type: dimension
  type: number
  hidden: false
  description: Flag indicating the earliest period (1) or not (0)
  sql: ${TABLE}.IsEarliestPeriodCheck

- name: data_period
  field_type: dimension_group
  type: time
  datatype: date
  hidden: true
  description: The snapshot period (end of month) associated with each row
  timeframes:
  - raw
  - date
  - month
  sql: ${TABLE}.DataPeriod

- name: churn_rate
  field_type: measure
  type: number
  label: Branch Account Churn Rate
  description: Churn rate calculated per branch per period
  value_format_name: percent_2
  sql: Max(${TABLE}.ChurnRate)


