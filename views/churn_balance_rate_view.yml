version: 1
type: view
name: churn_balance_rate_view
description: Derived table for calculating balance churn rate per period
model_name: strum_platform_model
default_date: data_period
derived_table:
  sql: |-
    SELECT
      pm.DataPeriod,
      COALESCE(lost.BalancesLostDuringPeriod, 0) AS BalancesLostDuringPeriod,
      COALESCE(start.TotalBalancesBeginningPeriod, 0) AS TotalBalancesBeginningPeriod,
      COALESCE(pf.IsEarliestPeriodCheck, 0) AS IsEarliestPeriodCheck,
      CASE
        WHEN COALESCE(pf.IsEarliestPeriodCheck, 0) = 1
          OR COALESCE(start.TotalBalancesBeginningPeriod, 0) = 0 THEN NULL
        ELSE (COALESCE(lost.BalancesLostDuringPeriod, 0) * 1.0
              / NULLIF(COALESCE(start.TotalBalancesBeginningPeriod, 0), 0)) * -1
      END AS ChurnRate
    FROM (
      SELECT 
        dp.DataPeriod,
        LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
      FROM (
        SELECT DISTINCT DataPeriod FROM AccountProfit
        WHERE DataPeriod != '1900-01-01'
      ) dp
    ) pm
    LEFT JOIN (
      SELECT
        a.DataPeriod,
        SUM(CASE WHEN a.islost = 1 THEN a.cur_bal END) * -1 AS BalancesLostDuringPeriod
      FROM AccountProfit a
      WHERE a.DataPeriod != '1900-01-01'
      GROUP BY a.DataPeriod
    ) lost ON pm.DataPeriod = lost.DataPeriod
    LEFT JOIN (
      SELECT
        prev_map.DataPeriod,
        SUM(CASE WHEN prev.islost = 0 THEN prev.cur_bal END) AS TotalBalancesBeginningPeriod
      FROM (
        SELECT 
          dp.DataPeriod,
          LAG(dp.DataPeriod) OVER (ORDER BY dp.DataPeriod) AS PreviousPeriod
        FROM (
          SELECT DISTINCT DataPeriod FROM AccountProfit
          WHERE DataPeriod != '1900-01-01'
        ) dp
      ) prev_map
      LEFT JOIN AccountProfit prev ON prev.DataPeriod = prev_map.PreviousPeriod
      GROUP BY prev_map.DataPeriod
    ) start ON pm.DataPeriod = start.DataPeriod
    LEFT JOIN (
      SELECT
        dp.DataPeriod,
        CASE WHEN dp.DataPeriod = (SELECT MIN(DataPeriod) FROM AccountProfit
                                   WHERE DataPeriod != '1900-01-01')
             THEN 1 ELSE 0 END AS IsEarliestPeriodCheck
      FROM (
        SELECT DISTINCT DataPeriod FROM AccountProfit
        WHERE DataPeriod != '1900-01-01'
      ) dp
    ) pf ON pm.DataPeriod = pf.DataPeriod
    GROUP BY
      pm.DataPeriod,
      lost.BalancesLostDuringPeriod,
      start.TotalBalancesBeginningPeriod,
      pf.IsEarliestPeriodCheck
fields:
- name: prim_key
  field_type: dimension
  type: string
  hidden: true
  primary_key: true
  sql: concat(${data_period_raw}, ${total_balances_beginning_period})
  searchable: true

- name: dataperiod
  field_type: dimension
  type: number
  hidden: false
  sql: ${TABLE}."DataPeriod"
  searchable: true

- name: balances_lost_during_period
  field_type: dimension
  type: number
  hidden: false
  label: Balances Lost
  sql: ${TABLE}.BalancesLostDuringPeriod
  searchable: true

- name: total_balances_beginning_period
  field_type: dimension
  type: number
  hidden: false
  label: Total Balances at Start
  sql: ${TABLE}.TotalBalancesBeginningPeriod
  searchable: true

- name: is_earliest_period_check
  field_type: dimension
  type: number
  hidden: false
  description: Flag indicating the earliest period (1) or not (0)
  sql: ${TABLE}.IsEarliestPeriodCheck

- name: data_period
  field_type: dimension_group
  type: time
  datatype: date
  hidden: true
  description: The snapshot period (end of month) associated with each row
  timeframes:
  - raw
  - date
  - month
  sql: ${TABLE}.DataPeriod

- name: churn_rate
  field_type: measure
  type: number
  label: Balance Churn Rate
  description: Balance churn rate calculated at runtime to avoid GROUP BY conflict.
  value_format_name: percent_2
  sql: MAX(${TABLE}.ChurnRate)

- name: churn_rate_avg
  field_type: measure
  type: average
  label: Avg Balance Churn Rate
  description: Churn rate calculated at runtime to avoid GROUP BY conflict.
  value_format_name: percent_2
  sql: ${TABLE}.ChurnRate


